%ya se ha hablado de robotario
\section{Hardware y software para el desarrollo del Robotario}\label{ch:HardwareYsoftware}
Para el montaje y desarrollo del Robotario se han usado diversos componentes, que se dividen en dos grupos. Los relacionados con el robot y los usados en el Robotario en general. En el robot se han usado componentes de bajo coste, siendo estos fáciles de adquirir y muy comunes en el mercado. A diferencia de los proyectos de referencia mencionados en la sección~\ref{ch:estadoArte}, se decide emplear para las comunicaciones la tecnología WiFi, que es fácil de implementar y tiene un precio asequible.
\begin{itemize}
	\item Chasis robot
	\item Arduino nano 33 IoT
	\item Integrado L298n
	\item Batería
	\item LM2596
	\item Encoder óptico
	\item RaspberryPI y Picam
	\item Lenguaje de programación C++
\end{itemize}
Y en el Robotario los componentes correspondientes son los relacionados con la comunicación y la localización donde se ha buscado también que sean asequibles y de fácil implementación:
\begin{itemize}
	\item Ordenador de sobremesa
	\item Suelo de goma
	\item Router
	\item Lenguaje de programación C y C++.
	\item OpenCV
\end{itemize}
\subsection{Robot móvil}
El robot móvil del Robotario cuenta con varios componentes.
\subsubsection{Chasis del robot}
\begin{figure}[!h]
	\centering
	\includegraphics[width=0.2\linewidth]{RobotAliexpres}
	\caption{ Chasis robot móvil}
	\label{fig:robotaliexpres}
\end{figure}

Se ha elegido un chasis de bajo presupuesto\cite{chasis} como el mostrado en la figura~\ref{fig:robotaliexpres} que incluye piezas simples y comunes que se pueden localizar fácilmente y se pueden reponer de manera sencilla si alguna se estropea. El chasis del robot incluye dos motores DC dos ruedas enganchadas a los motores, dos ruedas locas y consta de dos plantas. Los motores tienen un rango de funcionamiento de 2.5V a 9V según datos del fabricante.


\subsubsection{Arduino nano 33 IoT}

Para tener un control sobre el robot, obtener datos de los sensores y poder establecer la comunicación del robot con el servidor y los demás robots se usa una placa Arduino\cite{arduino} nano 33 IoT como la mostrada en la figura~\ref{fig:arduinonano33}. Arduino es una compañía de software y hardware libre que desarrolla y diseña placas con microcontroladores. La placa Arduino adquirida cuenta con un microprocesador Arm Cortex-M0 32-bit SAMD2. Además, tiene incorporado una antena, que permite la comunicación WiFi y Bluetooth. La placa cuenta con una IMU que incorpora acelerómetro y giróscopo, en este proyecto no se va a usar este módulo, pero es de utilidad para futuras ampliaciones.
\begin{figure}[!h]
	\centering
	\includegraphics[width=0.3\linewidth]{Arduinonano33}
	\caption{Placa de Arduino nano 33 IoT}
	\label{fig:arduinonano33}
\end{figure}
\subsubsection{Integrado L298n, puente H}
\begin{figure}[!h]
	\centering
	\includegraphics[width=0.25\linewidth]{PuenteH}
	\caption{L298n}
	\label{fig:puenteH}
\end{figure}
Para poder gobernar los motores correctamente se usa un puente H\cite{Hhbridge} para cada motor. En este caso se usa un integrado como el de la figura~\ref{fig:puenteH} que incorpora 2 puentes H y un regulador de tensión que proporciona 5 voltios a la salida y se usa para alimentar la placa de Arduino. El puente H es un circuito formado por transistores y diodos que es de uso común en el gobierno de motores. El integrado Ln298n cuenta con un rango de voltaje de entrada de 2.5V-46V y soporta una corriente DC de hasta 4 amperios. En el robot se alimenta con una batería de 9.9 voltios para ajustarse a al rango de operación de los motores. El puente H se alimenta con la tensión de entrada y se regula la alimentación que le llega al motor mediante una señal PWM procedente de la placa Arduino. Se detalla el funcionamiento de la señal PWM en conjunto con el puente H en el capítulo ~\ref{ch:ControlMotor}.
\newpage
\subsubsection{Encoder óptico}	%REVISAR LO DEL FILTRO%
\begin{figure}[h]
	\centering
	\includegraphics[width=0.25\linewidth]{ConstruccionRObot/Encoder}
	\caption{Encoder}
	\label{fig:encoder}
\end{figure} 
Para poder estimar la velocidad a la cual gira cada rueda y poder también estimar la distancia avanzada se emplean un par de encoder ópticos. El encoder óptico, es el modelo FC-03. En la figura~\ref{fig:encoder} se puede ver cómo es el componente electrónico. Revisando la hoja de características\cite{encoder} se sabe que tiene un LM393 que es un circuito integrado formado por dos comparadores. También lleva un optointerruptor, el cual consta de un diodo led y un transistor con la base expuesta.
El encoder además tiene dos salidas, una analógica y otra digital. Esta última es la que interesa debido a que es más sencillo para el microcontrolador leer entradas discretas que equivalen a un 1 cuando se lee un voltaje y un 0 cuando no hay voltaje o está por debajo de un umbral establecido. El voltaje de funcionamiento del sensor puede ser de 3.3V a 5V, como el microcontrolador solo soporta 3.3V será esta la alimentación que se proporcionará.


\subsubsection{LM2596 (conversor DC-DC)}
	\begin{figure}[!h]
		\centering
	\includegraphics[width=0.2\linewidth]{ConstruccionRObot/StepDown}
	\caption{Step-Down}
	\label{fig:StepDown}
	\end{figure}
Se emplean dos conversores DC-DC como el de la figura~\ref{fig:StepDown} para bajar el voltaje de salida de la batería, uno es para alimentar el módulo Ln298 y otro es para alimentar la raspberryPi a bordo que requiere como máximo 5V. De esta manera se evita el uso de otra batería y se separa la alimentación de la placa de Arduino y de la raspberryPi que se detalla a continuación.



\subsubsection{RaspberryPi y Picam}
	\begin{figure}[!h]
	\centering
	\includegraphics[width=0.25\linewidth]{raspberry_cam}
	\caption{RaspberryPi conectada con la cámara}
	\label{fig:raspyYcam}
\end{figure}
	Se tiene una placa RaspberryPi4 montada en el robot para poder procesar imágenes adquiridas por una cámara Picam que va conectada a la RaspberryPi tal y como se muestra en la figura~\ref{fig:raspyYcam}. Permite obtener imágenes con un angular de 160º según especificaciones del fabricante \cite{picam}. Este módulo no es esencial para el Robotario pero lo hace más versátil pudiendo experimentar con algoritmos de localización a bordo, visión artificial,etc.
\subsubsection{Batería}
\begin{figure}[!h]
	\centering
	\includegraphics[width=0.25\linewidth]{ConstruccionRObot/bat}
	\caption{batería}
	\label{fig:bateria}
\end{figure}
Para alimentar el robot se usa una batería LiFePo de 3 celdas de 3.3 V cada una como la observada en la figura~\ref{fig:bateria}. En total se tiene 2200mAh y 9.9V. Se usan dos baterías en paralelo para poder tener una mayor intensidad y tener una duración más larga de la batería. Esto se debe a que la raspberryPi requiere mucha potencia y reduce la duración de los experimentos en torno a 5 minutos.
	\subsubsection{Montaje final de robot}
	\begin{figure}[!h]
		\begin{subfigure}[b]{0.4\linewidth}
		\centering
		\includegraphics[width=0.52\linewidth]{RobotPerfil}
		\caption{Vista de perfil}
		\label{fig:robotfinalPerfil}
		\end{subfigure}
	\begin{subfigure}[b]{0.4\linewidth}
		\centering
		\includegraphics[width=0.52\linewidth]{RobotFrente}
		\caption{Vista de frente}
		\label{fig:robotfinalFrente}
	\end{subfigure}
	\caption{Montaje final de robot}
	\label{fig:robotFinal}
	\end{figure}
En la Figura~\ref{fig:robotFinal} se tiene el robot construido, con los componentes anteriormente mencionados. Al robot se le ha añadido una tercera planta para poder incorporar la cámara y la raspberryPi. En este momento se tienen 3 robots montados.


	\subsection{Camara logitech C920}
		\begin{figure}[!h]
		\centering
		\includegraphics[width=0.2\linewidth]{Camaralogi}
		\caption{Cámara Logitech}
		\label{fig:camaralogi}
	\end{figure}

Se tienen 3 cámaras logitech C920 como la mostrada en la figura~\ref{fig:camaralogi} que se usan para la localización de los robots. En el actual montaje del Robotario solo se usa una cámara. La conexión se realiza mediante USB al ordenador que hace de servidor. La cámara tiene una resolución de 1080p. Se puede grabar a 30 fps como máximo, es decir que se procesan 30 imágenes en un segundo, esto es más que suficiente para el Robotario.

\subsection{Ordenador de sobremesa}
El ordenador que hace de servidor es un ordenador de sobremesa con un procesador i7 de sexta generación y con 6 GB de ram, el sistema operativo que se usa para el propósito del Robotario es Ubuntu 20.04.
	\subsection{Suelo de goma}	
Se usa un suelo de goma que permite que los robots no deslicen al desplazarse, también sirve para delimitar el área del Robotario.
\subsection{Router}
El Router permite la comunicación de los distintos dispositivos de la red, es un Router convencional de la marca ZTE. Sus características son las siguientes:
\begin{itemize}
	\item Wireless: en la banda de 2.4GHz se tiene una velocidad de hasta 450Mbps. En la banda de 5GHz se tiene una velocidad de hasta 1300Mbps.
	\item Se tiene un ancho de banda inalámbrico máximo de 1750Mbps.
	\item Potencia máxima en 2.4GHz de 20dBm.
	\item Potencia máxima en 5 GHz de 23dBm y en la banda de 547-5725MHz la potencia máxima es de 30 dBm.
\end{itemize}
Según un análisis realizado por Red zone \cite{router} el router es más que suficiente para la situación actual de Robotario que cuenta con 3 robots construidos y pronto serán 5. Se entra en más profundidad en el análisis de las características de la red en el capítulo ~\ref{ch:RedLan}.
\subsection{Software}
El software a usar está relacionado con la programación de la placa de Arduino, la raspberryPi y la localización.

\subsubsection{Lenguaje de programación}
Todo el entorno de comunicación se ha desarrollado en C, con los sockets que se tienen en sistemas operativos Unix/linux y también con programación multihilo propia de sistemas Unix.\\
La placa de Arduino se ha programado en c++ y empleando el conjunto de librerías que proporciona el entorno de Arduino.
\subsubsection{OpenCV}\label{ch:openCV}
\begin{figure}[h]
	\centering
	\includegraphics[width=0.3\linewidth]{EjemploDeMarker}
	\caption{Ejemplos de Marker\cite{MarkeropenCV}}
	\label{fig:ejemplodemarker}
\end{figure}

Para la visión por computador se usa una librería denominada OpenCV \cite{opencv_library} que está desarrollada en dos lenguajes de programación C++ y Python. Permite reconocer el entorno con una cámara y tratar las imágenes para desarrollar la aplicación que se desee. En este proyecto se usa ArUco\cite{ArUco1}\cite{ArUco2} de OpenCV, que permite el reconocimiento de un Marker de tamaño 4x4 formado por 16 bits. En la figura ~\ref{fig:ejemplodemarker} se tiene un ejemplo de como son lo identificadores de los robots. Estos van colocados uno encima de los robots y otro en la parte delantera/trasera de estos. 
En la Figura ~\ref{fig:robotMarker} se muestra como están colocados los Markers en el robot para poder localizarlo.
\begin{figure}[h]
	\centering
	\includegraphics[width=0.3\linewidth]{RobotMarker}
	\caption{Robot con Marker para la localización}
	\label{fig:robotMarker}
\end{figure}
\subsection{Coste del material}
El cuadro~\ref{tab:MatRobot} muestra el precio de los componentes de un robot.
\begin{table}[h]
\begin{center}
	\begin{tabular}{| c | c |}
		\hline
		Material Robot & Precio(\euro) \\ 
		\hline
		Arduino nano 33 IoT & 16.00 \\
		\hline
		Chasis robot & 10.47 \\
		\hline
		Ln298(puente H) & 2.79 \\
		\hline
		step Down(x2) & 1.66 \\
		\hline
		Encoder óptico & 2.30 \\
		\hline
		Placa para soldar circuito & 5.05 \\
		\hline
		Ruedas de bola(x2) & 2.74 \\
		\hline
		switch & 0.82 \\
		\hline
		Bateria & 18.90 \\
		\hline
		Condensador de desacoplo & 0.16 \\
		\hline
		Condensador Filtro encoder & 0.06 \\
		\hline
		RaspberryPi 4, 2GB & 57.00\\
		\hline
		Picam & 17.04\\
		\hline
		TOTAL & 134.99 \\
		\hline
	\end{tabular} 
	\caption{Material robot}
	\label{tab:MatRobot} 
\end{center}
\end{table}
El componente más caro del robot es la raspberryPi. Por 134.99 \euro, se tiene un robot que permite desarrollar diversos algoritmos en el entorno de pruebas y puede comunicarse y reconocer el entorno. Además, el Robotario puede funcionar sin la raspberryPi y la cámara de Picam, pero esto limita el tipo de experimentos realizables. En total el coste de los robots del Robotario, con 5 robots adquiridos de los cuales 2 tiene RaspberryPi es de 452.83 \euro.\\
El material restante, necesario para la comunicación y para que los robots se muevan de manera adecuada, es el mostrado en el Cuadro ~\ref{tab:MatRobotario}	
\begin{table}[h]
	\begin{center}
		\begin{tabular}{| c | c |}
			\hline
			Material Robotario & Precio(\euro) \\ 
			\hline
			Cámara logitech c920 & 54.00 \\
			\hline
			Suelo de goma & 20.00 \\
			\hline
			Router & 35.00 \\
			\hline
			Ordenador de sobre-mesa & 560.00\\
			\hline
			TOTAL & 669.00 \\
			\hline
		\end{tabular}
	\caption{Material Robotario}
	\label{tab:MatRobotario}  
	\end{center}
\end{table}
\\En total, por 1121.83 \euro, \thinspace se tiene un Robotario funcional.
\newpage
\subsection{Montaje final de Robotario}
Por último, con los componentes adquiridos se ensambla el Robotario que se muestra en la figura ~\ref{fig:montajefinal}. La cámara Logitech, se coloca como cámara cenital que sirve como sistema de localización global. Se coloca encima de los límites del Robotario y lo más centrada posible.
Por último, se instala un suelo de goma en la zona del Robotario que marcará sus límites. Se hacen pruebas de movimientos con los robots y se detecta que, a pesar de ser el suelo de goma, al ser de baja calidad los robots se quedan atrapados en algunas zonas, reduciendo su velocidad o en otras zonas sus ruedas motrices resbalan. La solución a futuro es adquirir un suelo de goma duro y liso, similar al que se puede encontrar en un gimnasio.

En la figura ~\ref{fig:montajefinal} se puede ver cómo queda el Robotario montado, con 3 robots. En el techo se puede ver la cámara colocada. En la imagen se aprecia como el espacio es pequeño, por ello se tiene la necesidad de que los robots vayan despacio, para aprovechar de manera eficaz el espacio. Las medidas del Robotario son 180cm de largo y 132 cm de ancho. Las medidas están limitas por la disponibilidad del espacio en el lugar que se encuentra el Robotario\\ 
\begin{figure}[!h]
	\centering
	\includegraphics[scale=0.6]{MontajeFinal}
	\caption{Montaje final del Robotario}
	\label{fig:montajefinal}
\end{figure}
\newpage