\subsection{Tratamiento del ruido}

Las lecturas que realiza la placa de Arduino de los pulsos de los encoders ópticos no son buenas, la placa de Arduino lee más pulsos de los reales, esto provoca que la estimación de la velocidad no se haga de manera correcta.
Se tienen dos problemas identificados, uno es mecánico y se debe a que los ejes donde se enganchan las ruedas motrices tienen holgura y esto provoca  una oscilación sobre el propio eje de la rueda motriz y otro problema es que el eje se dobla ligeramente cuando se posa sobre el suelo. Esto último hace que haya mas superficie de contacto en un lado de la rueda que en el otro. Y Estos problemas provocan oscilaciones en el movimiento y por lo tanto en las lecturas. Estos problemas se deben a la calidad de los componentes puesto que es un robot de bajo presupuesto no se tiene solución a no ser que se cambie de hardware. Se trata este ruido como incertidumbre en la medida.\\

El otro problema identificado es ruido eléctrico. Se debe a que se alimenta el circuito de potencia y el de la placa de arduino con la misma batería, y lo único que separa un circuito del otro es el regulador de tensión que incorpora el integrado LN298n. Al ser de baja calidad no consigue aislar un circuito del otro. Se coloca un condensador de desacoplo en la alimentación de la placa de arduino para minimizar el ruido de alta frecuencia. A pesar de está solución debido a la comunicación de la placa de Arduino con los motores y con los encoders, que se hace mediante pulsos. Se tiene ruido debido a la diafonía que producen estas señales, se ha trenzado los cables como medida de protección pero, en el propio integrado de la placa de Arduino no se puede hacer nada para solucionarlo.\\

\begin{figure}[h]
	\centering
	\includegraphics[width=0.7\linewidth]{estimaVelocidad/TratamientoRuido/PulsosEncoder_sinFiltro}
	\caption{Salida de encoder sin filtro}
	\label{fig:pulsosencodersinfiltro}
\end{figure}
En la figura ~\ref{fig:pulsosencodersinfiltro} se tiene una lectura del encoder que se hace con un osciloscopio. Se puede apreciar que existe un pulso que no debería estar entre el segundo -0.35 y el segundo -0.3, además de los diferentes niveles de voltaje intermedios que se aprecia en la figura, esto provoca errores en la lectura del encoder.\\

	

 Una solución que se aplica es diseñar un filtro paso-bajo, la manera mas sencilla de hacerlo es mediante un condensador, este condensador se coloca entre la salida analógica y tierra. Se usa condensador  de 47 $n_{f}$ este filtrará componentes de alta frecuencia y no deformará el pulso de manera significativa. Hay que modificar las interrupciones para que se hagan cuando la placa de Arduino detecte un flanco de subida. En la figura ~\ref{fig:pulsosencoderconfiltro} se puede observar el resultado final con el filtro paso-bajo, se han eliminado pulsos intermedios y se tiene definido un flanco de subida que se utiliza para las interrupciones.\\
 		\begin{figure}[h]
 	\centering
 	\includegraphics[width=0.6\linewidth]{estimaVelocidad/TratamientoRuido/PulsosEncoder_ConFiltro}
 	\caption{Lectura de pulsos con filtro paso-bajo}
 	\label{fig:pulsosencoderconfiltro}
 \end{figure}
 
A pesar de que este método corrige de buena manera el problema con el ruido y la estima de la velocidad, la placa de Arduino sigue contando más pulsos de los reales, esto se puede deber al problema de diafonía que se comentó o a la interferencia causada por el campo magnético que generan los motores DC, que están muy cerca de los encoders y de la placa de Arduino. Se ha alejado lo máximo posible la placa Arduino de los motores DC, aun así se sigue teniendo error en la cuenta de pulsos que realiza la placa de Arduino, por lo que se recurre a filtros digitales que irán programados en la rutina de la placa de Arduino que se usa para estimar la velocidad. 

Uno de los métodos aplicados, es poner un límite de tiempo entre detecciones de pulsos, se analiza con un osciloscopio el periodo de la señal a una velocidad máxima correspondiente al voltaje máximo impuesto, las medidas se realizan con las ruedas al aire sin el rozamiento del suelo. De este modo los valores obtenidos son mayores que los descritos en la sección~\ref{ch:controlmotorLimitacion}. También se hace la condición menos restrictiva  al no tener en cuenta el rozamiento del suelo, e impide que si por alguna razón la rueda gira más rápido de $15 rad/s$ no se obtengan errores en la medida, y se tenga una lectura correcta y el controlador actúe correctamente. Del osciloscopio se obtiene que este periodo es de 13.54ms en la Figura ~\ref{fig:maxvelencoder} se puede ver los pulsos de los encoders para una velocidad máxima que corresponde con un voltaje de 6.5V. Con esta configuración se condiciona la detección por interrupciones de arduino, despreciando los pulsos que ocurren en un intervalo inferior de tiempo.\\

	\begin{figure}[h]
	\centering
	\includegraphics[width=0.7\linewidth]{estimaVelocidad/TratamientoRuido/maxVelEncoder}
	\caption{Pulsos de encoder a velocidad máxima de la rueda. \\ Voltaje de 6.5V en el motor}
	\label{fig:maxvelencoder}
\end{figure}

Esta condición de tiempo para contar pulsos ha mejorado notablemente respecto a los casos anteriores, comparando los pulsos contados con la placa de Arduino y los que se obtienen con el osciloscopio, de 500 pulsos se obtiene un error del 5\% aproximadamente, pero debido a los problemas mecánicos mencionados, se sigue teniendo ruido en la lectura de pulsos, por ello como último recurso se aplica un filtro de media móvil que hace un promedio de los intervalos de tiempo entre dos pulsos consecutivos que se van registrando. Así cuando la rutina de Arduino tome un valor para estimar la velocidad, tomara un promedio de dichos valores.
\[ 
y(i)=\frac{1}{M} \sum_{j=0}^{M-1}x(i+j)
\]
El filtro  hace una media de los últimos M valores de tiempo que se van registrando, donde M se denomina la ventana del filtro, de esta manera se consigue una lectura más suave de la velocidad. Se ha probado con varios valores de M, se ha optado por tener 10 valores, que equivale a la mitad de los pulsos que da una rueda, recordando que su resolución es de 20.\\

 Cuando la placa de Arduino ha registrado los intervalos de tiempo de la rueda en movimiento y después se para, la velocidad se queda con el último tiempo medido y debido al filtro de media móvil, este valor desciende a cero pero con un retraso importante. Para evitar esto se impone una condición. Si durante un intervalo de tiempo no se ha registrado ningún pulso proveniente del encoder, la velocidad se pone a cero. El tiempo que se ha puesto es de 100 ms.
